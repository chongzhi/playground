<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>calculations.js 基础单元测试</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 16px; }
    .pass { color: #2e7d32; }
    .fail { color: #c62828; }
    code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>calculations.js 基础单元测试</h1>
  <div id="results"></div>

  <script type="module">
    import { calculateHoldings, calculateAccountBalance, calculateProfitAnalysis } from '../js/calculations.js';

    const results = document.getElementById('results');
    let passed = 0; let failed = 0; let total = 0;

    function expect(name, fn) {
      total++;
      try {
        fn();
        const p = document.createElement('p');
        p.className = 'pass';
        p.textContent = `✓ ${name}`;
        results.appendChild(p);
        passed++;
      } catch (err) {
        const p = document.createElement('p');
        p.className = 'fail';
        p.innerHTML = `✗ ${name}<br><code>${err && err.message ? err.message : err}</code>`;
        results.appendChild(p);
        failed++;
      }
    }

    function assertEqual(actual, expected, msg) {
      if (actual !== expected) throw new Error(`${msg} | actual=${actual}, expected=${expected}`);
    }

    function assertNear(actual, expected, epsilon, msg) {
      if (Math.abs(actual - expected) > epsilon) throw new Error(`${msg} | actual=${actual}, expected=${expected}, eps=${epsilon}`);
    }

    // 用例数据
    const txs = [
      { id: '1', code: 'AAPL', name: 'Apple', type: 'buy', price: 100, quantity: 10, date: '2024-01-01' },
      { id: '2', code: 'AAPL', name: 'Apple', type: 'buy', price: 200, quantity: 10, date: '2024-02-01' },
      { id: '3', code: 'AAPL', name: 'Apple', type: 'sell', price: 150, quantity: 10, date: '2024-03-01' },
      { id: '4', code: 'MSFT', name: 'Microsoft', type: 'buy', price: 50, quantity: 4, date: '2024-01-15' },
    ];

    // 1) 持仓：AAPL 应剩余 10 股，均价 150；MSFT 4 股，均价 50
    // AAPL计算过程：买入10@100 + 买入10@200 = 20股$3000，卖出10股后剩余10股$1500，均价$150
    expect('calculateHoldings() 基本计算', () => {
      const h = calculateHoldings(txs);
      assertEqual(Object.keys(h).sort().join(','), 'AAPL,MSFT', '应有两只股票持仓');
      assertEqual(h.AAPL.quantity, 10, 'AAPL 剩余数量');
      assertNear(h.AAPL.avgCost, 150, 1e-9, 'AAPL 平均成本');
      assertEqual(h.MSFT.quantity, 4, 'MSFT 数量');
      assertNear(h.MSFT.avgCost, 50, 1e-9, 'MSFT 平均成本');
    });

    // 2) 现金余额（含佣金）：每笔佣金=每股0.02，最低5。
    //    初始 10_000
    //    买入1：-1000 -5 = -1005
    //    买入2：-2000 -5 = -2005
    //    卖出 ：+1500 -5 = +1495
    //    买入3：-200  -5 = -205
    //    合计变动：-1720 => 余额 10_000 - 1720 = 8_280
    expect('calculateAccountBalance() 基本计算', () => {
      const balance = calculateAccountBalance(txs, 10000);
      assertEqual(balance, 8280, '余额应为 8280');
    });

    // 3) 盈亏分析：假设用户价 AAPL=210，MSFT=40
    expect('calculateProfitAnalysis() 基本计算', () => {
      const h = calculateHoldings(txs);
      const p = calculateProfitAnalysis(h, { AAPL: 210, MSFT: 40 });
      // AAPL: 10 * 210 = 2100，成本 150*10=1500，盈亏 +600
      // MSFT: 4 * 40 = 160，成本 4*50=200，盈亏 -40
      // 总成本 1700，总市值 2260，总盈亏 +560
      assertEqual(p.totalCost, 1700, '总成本');
      assertEqual(p.totalValue, 2260, '总市值');
      assertEqual(p.totalProfit, 560, '总盈亏');
      assertNear(p.totalProfitPercent, (560/1700)*100, 1e-9, '总收益率');
    });

    const summary = document.createElement('p');
    summary.innerHTML = `<strong>结果：</strong> 通过 ${passed}/${total}，失败 ${failed}`;
    results.appendChild(summary);
  </script>
</body>
</html>
