<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>éªŒè¯å¹³å‡æˆæœ¬ä»·è®¡ç®—</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .result {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #4CAF50;
            background: #f9f9f9;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            font-weight: bold;
        }
        .error {
            color: #d32f2f;
            font-weight: bold;
        }
        .success {
            color: #2e7d32;
            font-weight: bold;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å¹³å‡æˆæœ¬ä»·è®¡ç®—éªŒè¯</h1>
    <div id="result"></div>

    <script type="module">
        import { calculateHoldings } from './js/calculations.js';
        import { roundToDecimals, divide, multiply, add, subtract } from './js/precision.js';

        // ç”¨æˆ·çš„äº¤æ˜“åœºæ™¯
        const transactions = [
            {
                id: '1',
                code: 'A',
                name: 'Aè‚¡ç¥¨',
                type: 'buy',
                price: 24.58,
                quantity: 400,
                date: '2025-01-01'
            },
            {
                id: '2',
                code: 'A',
                name: 'Aè‚¡ç¥¨',
                type: 'buy',
                price: 21.24,
                quantity: 470,
                date: '2025-01-02'
            },
            {
                id: '3',
                code: 'A',
                name: 'Aè‚¡ç¥¨',
                type: 'sell',
                price: 20.5,
                quantity: 470,
                date: '2025-01-03'
            }
        ];

        // æ‰‹åŠ¨é€æ­¥è®¡ç®—ï¼Œæ¨¡æ‹Ÿä»£ç é€»è¾‘
        function manualCalculation() {
            let html = '<div class="result">';
            html += '<h2>ğŸ“Š æ‰‹åŠ¨é€æ­¥è®¡ç®—ï¼ˆæ¨¡æ‹Ÿä»£ç é€»è¾‘ï¼‰</h2>';

            let quantity = 0;
            let totalCost = 0;
            let avgCost = 0;

            // ç¬¬ä¸€æ­¥ï¼šä¹°å…¥400è‚¡ @ 24.58
            html += '<div class="step">';
            html += '<h3>æ­¥éª¤1: ä¹°å…¥ 400è‚¡ @ $24.58</h3>';
            const buyCost1 = multiply(24.58, 400);
            totalCost = add(totalCost, buyCost1);
            quantity += 400;
            avgCost = quantity > 0 ? divide(totalCost, quantity) : 0;
            
            html += `<p>ä¹°å…¥æˆæœ¬ = 24.58 Ã— 400 = <span class="highlight">${buyCost1}</span></p>`;
            html += `<p>æ€»æˆæœ¬ = 0 + ${buyCost1} = <span class="highlight">${totalCost}</span></p>`;
            html += `<p>æŒä»“æ•°é‡ = <span class="highlight">${quantity}</span>è‚¡</p>`;
            html += `<p>å¹³å‡æˆæœ¬ = ${totalCost} Ã· ${quantity} = <span class="highlight">$${avgCost}</span></p>`;
            html += '</div>';

            // ç¬¬äºŒæ­¥ï¼šä¹°å…¥470è‚¡ @ 21.24
            html += '<div class="step">';
            html += '<h3>æ­¥éª¤2: ä¹°å…¥ 470è‚¡ @ $21.24</h3>';
            const buyCost2 = multiply(21.24, 470);
            const oldTotalCost = totalCost;
            totalCost = add(totalCost, buyCost2);
            const oldQuantity = quantity;
            quantity += 470;
            avgCost = quantity > 0 ? divide(totalCost, quantity) : 0;
            
            html += `<p>ä¹°å…¥æˆæœ¬ = 21.24 Ã— 470 = <span class="highlight">${buyCost2}</span></p>`;
            html += `<p>æ€»æˆæœ¬ = ${oldTotalCost} + ${buyCost2} = <span class="highlight">${totalCost}</span></p>`;
            html += `<p>æŒä»“æ•°é‡ = ${oldQuantity} + 470 = <span class="highlight">${quantity}</span>è‚¡</p>`;
            html += `<p>å¹³å‡æˆæœ¬ = ${totalCost} Ã· ${quantity} = <span class="highlight">$${avgCost}</span></p>`;
            html += '</div>';

            // ç¬¬ä¸‰æ­¥ï¼šå–å‡º470è‚¡ @ 20.5
            html += '<div class="step">';
            html += '<h3>æ­¥éª¤3: å–å‡º 470è‚¡ @ $20.5</h3>';
            const avgCostBeforeSell = divide(totalCost, quantity);
            const costOfSoldShares = multiply(avgCostBeforeSell, 470);
            const oldTotalCost2 = totalCost;
            totalCost = subtract(totalCost, costOfSoldShares);
            const oldQuantity2 = quantity;
            quantity -= 470;
            avgCost = quantity > 0 ? divide(totalCost, quantity) : 0;
            
            html += `<p>å½“å‰å¹³å‡æˆæœ¬ = ${oldTotalCost2} Ã· ${oldQuantity2} = <span class="highlight">$${avgCostBeforeSell}</span></p>`;
            html += `<p>å–å‡ºéƒ¨åˆ†çš„æˆæœ¬ = ${avgCostBeforeSell} Ã— 470 = <span class="highlight">${costOfSoldShares}</span></p>`;
            html += `<p>å‰©ä½™æ€»æˆæœ¬ = ${oldTotalCost2} - ${costOfSoldShares} = <span class="highlight">${totalCost}</span></p>`;
            html += `<p>å‰©ä½™æ•°é‡ = ${oldQuantity2} - 470 = <span class="highlight">${quantity}</span>è‚¡</p>`;
            html += `<p>å‰©ä½™å¹³å‡æˆæœ¬ = ${totalCost} Ã· ${quantity} = <span class="highlight">$${avgCost}</span></p>`;
            html += '</div>';

            html += '<div class="step" style="border-left-color: #2196F3;">';
            html += '<h3>ğŸ¯ æœ€ç»ˆç»“æœ</h3>';
            html += `<p style="font-size: 1.2em;">å‰©ä½™æŒä»“: <span class="highlight">${quantity}è‚¡</span></p>`;
            html += `<p style="font-size: 1.2em;">å¹³å‡æˆæœ¬: <span class="highlight">$${avgCost}</span></p>`;
            
            // åˆ¤æ–­æ˜¯å¦åˆç†
            if (avgCost === 22.77) {
                html += `<p class="success">âœ“ ä¸ç”¨æˆ·çœ‹åˆ°çš„ $22.77 ä¸€è‡´</p>`;
            } else {
                html += `<p class="error">âœ— ä¸ç”¨æˆ·çœ‹åˆ°çš„ $22.77 ä¸ä¸€è‡´</p>`;
                html += `<p>å·®å¼‚: ${Math.abs(avgCost - 22.77).toFixed(4)}</p>`;
            }
            html += '</div>';

            html += '</div>';
            return html;
        }

        // ä½¿ç”¨å®é™…ä»£ç è®¡ç®—
        function codeCalculation() {
            const holdings = calculateHoldings(transactions);
            let html = '<div class="result">';
            html += '<h2>ğŸ’» å®é™…ä»£ç è®¡ç®—ç»“æœ</h2>';
            
            if (holdings['A']) {
                const stock = holdings['A'];
                html += '<table>';
                html += '<tr><th>å­—æ®µ</th><th>å€¼</th></tr>';
                html += `<tr><td>è‚¡ç¥¨ä»£ç </td><td>${stock.code}</td></tr>`;
                html += `<tr><td>è‚¡ç¥¨åç§°</td><td>${stock.name}</td></tr>`;
                html += `<tr><td>æŒä»“æ•°é‡</td><td>${stock.quantity}è‚¡</td></tr>`;
                html += `<tr><td>æ€»æˆæœ¬</td><td>$${stock.totalCost}</td></tr>`;
                html += `<tr><td>å¹³å‡æˆæœ¬</td><td>$${stock.avgCost}</td></tr>`;
                html += '</table>';
                
                if (stock.avgCost === 22.77) {
                    html += `<p class="success">âœ“ è®¡ç®—ç»“æœä¸º $22.77ï¼Œä¸ç”¨æˆ·çœ‹åˆ°çš„ä¸€è‡´</p>`;
                } else {
                    html += `<p class="error">âœ— è®¡ç®—ç»“æœä¸º $${stock.avgCost}ï¼Œä¸ç”¨æˆ·çœ‹åˆ°çš„ $22.77 ä¸ä¸€è‡´</p>`;
                }
            }
            
            html += '</div>';
            return html;
        }

        // ç†è®ºåˆ†æ
        function theoreticalAnalysis() {
            let html = '<div class="result">';
            html += '<h2>ğŸ“ ç†è®ºåˆ†æï¼šåŠ æƒå¹³å‡æˆæœ¬æ³•</h2>';
            
            html += '<div class="step">';
            html += '<h3>åŸç†è¯´æ˜</h3>';
            html += '<p>åŠ æƒå¹³å‡æˆæœ¬æ³•çš„ç‰¹ç‚¹ï¼š</p>';
            html += '<ul>';
            html += '<li>æ‰€æœ‰ä¹°å…¥çš„è‚¡ç¥¨æ··åˆåœ¨ä¸€èµ·ï¼Œä¸åŒºåˆ†æ‰¹æ¬¡</li>';
            html += '<li>æ¯æ¬¡ä¹°å…¥åé‡æ–°è®¡ç®—å¹³å‡æˆæœ¬</li>';
            html += '<li><strong>å–å‡ºæ—¶ï¼ŒæŒ‰å½“å‰å¹³å‡æˆæœ¬æ‰£é™¤ç›¸åº”ä»½é¢çš„æˆæœ¬</strong></li>';
            html += '<li>å–å‡ºåï¼Œå‰©ä½™è‚¡ç¥¨çš„å¹³å‡æˆæœ¬åº”ä¿æŒä¸å˜ï¼ˆç†è®ºä¸Šï¼‰</li>';
            html += '</ul>';
            html += '</div>';

            html += '<div class="step">';
            html += '<h3>ç²¾åº¦åˆ†æ</h3>';
            html += '<p>è®©æˆ‘ä»¬ç”¨æ›´é«˜ç²¾åº¦è®¡ç®—ï¼š</p>';
            
            // é«˜ç²¾åº¦è®¡ç®—
            const cost1 = 24.58 * 400; // 9832
            const cost2 = 21.24 * 470; // 9982.8
            const totalCostRaw = cost1 + cost2; // 19814.8
            const avgCostRaw = totalCostRaw / 870; // 22.775632183908046
            
            html += `<p>ç¬¬ä¸€æ¬¡ä¹°å…¥æˆæœ¬: 24.58 Ã— 400 = <span class="highlight">${cost1}</span></p>`;
            html += `<p>ç¬¬äºŒæ¬¡ä¹°å…¥æˆæœ¬: 21.24 Ã— 470 = <span class="highlight">${cost2}</span></p>`;
            html += `<p>æ€»æˆæœ¬: ${cost1} + ${cost2} = <span class="highlight">${totalCostRaw}</span></p>`;
            html += `<p>å¹³å‡æˆæœ¬ï¼ˆåŸå§‹ï¼‰: ${totalCostRaw} Ã· 870 = <span class="highlight">${avgCostRaw}</span></p>`;
            html += `<p>å¹³å‡æˆæœ¬ï¼ˆ2ä½å°æ•°ï¼‰: <span class="highlight">${avgCostRaw.toFixed(2)}</span></p>`;
            
            // å–å‡ºè®¡ç®— - ä½¿ç”¨å››èˆäº”å…¥åçš„å€¼
            const avgCostRounded = Math.round(avgCostRaw * 100) / 100; // 22.78
            const soldCost1 = avgCostRounded * 470; // 10706.6
            const remainCost1 = totalCostRaw - soldCost1; // 9108.2
            const remainAvg1 = remainCost1 / 400; // 22.7705
            
            html += '<br><p><strong>æ–¹æ¡ˆAï¼šå–å‡ºæ—¶ä½¿ç”¨å››èˆäº”å…¥åçš„å¹³å‡æˆæœ¬</strong></p>';
            html += `<p>å››èˆäº”å…¥åçš„å¹³å‡æˆæœ¬: <span class="highlight">${avgCostRounded}</span></p>`;
            html += `<p>å–å‡ºæˆæœ¬: ${avgCostRounded} Ã— 470 = <span class="highlight">${soldCost1}</span></p>`;
            html += `<p>å‰©ä½™æˆæœ¬: ${totalCostRaw} - ${soldCost1} = <span class="highlight">${remainCost1}</span></p>`;
            html += `<p>å‰©ä½™å¹³å‡æˆæœ¬: ${remainCost1} Ã· 400 = <span class="highlight">${remainAvg1}</span></p>`;
            html += `<p>å››èˆäº”å…¥: <span class="highlight">${remainAvg1.toFixed(2)}</span> âœ“ å¾—åˆ° $22.77</p>`;
            
            // ä½¿ç”¨åŸå§‹ç²¾åº¦
            const soldCost2 = avgCostRaw * 470; // 10704.547126436781
            const remainCost2 = totalCostRaw - soldCost2; // 9110.252873563218
            const remainAvg2 = remainCost2 / 400; // 22.775632183908045
            
            html += '<br><p><strong>æ–¹æ¡ˆBï¼šå–å‡ºæ—¶ä½¿ç”¨åŸå§‹ç²¾åº¦</strong></p>';
            html += `<p>å–å‡ºæˆæœ¬: ${avgCostRaw} Ã— 470 = <span class="highlight">${soldCost2}</span></p>`;
            html += `<p>å‰©ä½™æˆæœ¬: ${totalCostRaw} - ${soldCost2} = <span class="highlight">${remainCost2}</span></p>`;
            html += `<p>å‰©ä½™å¹³å‡æˆæœ¬: ${remainCost2} Ã· 400 = <span class="highlight">${remainAvg2}</span></p>`;
            html += `<p>å››èˆäº”å…¥: <span class="highlight">${remainAvg2.toFixed(2)}</span> âœ“ å¾—åˆ° $22.78</p>`;
            
            html += '</div>';
            
            html += '<div class="step" style="border-left-color: #FF9800;">';
            html += '<h3>âš ï¸ ç²¾åº¦æŸå¤±åˆ†æ</h3>';
            html += '<p>ç”±äºåœ¨è®¡ç®—è¿‡ç¨‹ä¸­è¿›è¡Œäº†ä¸­é—´å››èˆäº”å…¥ï¼Œå¯¼è‡´ï¼š</p>';
            html += '<ul>';
            html += '<li>çœŸå®å¹³å‡æˆæœ¬: 22.775632...</li>';
            html += '<li>å››èˆäº”å…¥å: 22.78ï¼ˆç”¨äºå–å‡ºè®¡ç®—ï¼‰</li>';
            html += '<li>è¿™å¯¼è‡´å–å‡ºæ‰£é™¤çš„æˆæœ¬ç•¥å¤šï¼ˆ10706.6 vs 10704.55ï¼‰</li>';
            html += '<li>å› æ­¤å‰©ä½™æˆæœ¬å˜å°‘ï¼Œå‰©ä½™å¹³å‡æˆæœ¬ä» 22.78 é™åˆ° 22.77</li>';
            html += '</ul>';
            html += '<p><strong>ç»“è®ºï¼š$22.77 æ˜¯ç”±äºç²¾åº¦å¤„ç†å¯¼è‡´çš„ï¼Œåœ¨æŠ€æœ¯ä¸Šæ˜¯"æ­£ç¡®"çš„ï¼ˆç¬¦åˆä»£ç é€»è¾‘ï¼‰ï¼Œä½†åœ¨ä¼šè®¡ä¸Šç•¥æœ‰åå·®ã€‚</strong></p>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }

        // æ¸²æŸ“ç»“æœ
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = codeCalculation() + manualCalculation() + theoreticalAnalysis();
    </script>
</body>
</html>

