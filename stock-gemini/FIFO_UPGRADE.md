# 成本价计算算法升级：从加权平均到 FIFO

## 📋 修改概述

将持仓成本计算方法从 **加权平均成本法** 升级为 **FIFO（先进先出）法**。

### 修改日期
2025-10-31

### 修改文件
- `js/calculations.js` - `calculateHoldings()` 函数

---

## 🎯 为什么要修改？

### 旧算法（加权平均）的问题

#### 问题 1：成本混合不直观
```
1. 买入 400股 @ $24.58
2. 买入 470股 @ $21.24
→ 混合成 870股 @ $22.78（平均）

3. 卖出 470股
→ 剩余 400股 @ $22.77
```

**问题**：剩余成本 $22.77 既不是 $24.58，也不是 $21.24，不符合直觉。

#### 问题 2：盈利假象
```
按上述例子：
- 系统显示剩余成本：$22.77
- 如果在 $24.00 卖出：看起来赚 $1.23/股
- 但整体现金流计算：实际亏损 $579.80
```

**问题**：已实现的亏损被"隐藏"在剩余持仓成本中，误导投资决策。

---

## ✅ 新算法（FIFO）的优势

### 1. 批次管理
每批买入独立追踪，不混合：
```javascript
lots: [
  { price: 24.58, quantity: 400, date: '2025-01-01' },
  { price: 21.24, quantity: 470, date: '2025-01-02' }
]
```

### 2. 先进先出逻辑
卖出时从最早买入的批次开始：
```
卖出 470股：
1. 先卖批次1：400股 @ $24.58 ✓ 全卖
2. 再卖批次2：70股 @ $21.24 ✓ 部分卖
→ 剩余：400股 @ $21.24（批次2剩余）
```

### 3. 真实成本
剩余持仓的成本反映实际买入价格：
- ✅ $21.24 是真实买入价
- ❌ 不是计算出来的平均价 $22.77

### 4. 税务合规
- 符合大多数国家税务要求
- 与券商默认行为一致
- 便于税务申报和审计

---

## 🔧 技术实现

### 核心数据结构

```javascript
// 旧算法
{
  code: 'A',
  name: 'A股票',
  quantity: 400,
  totalCost: 9108.2,
  avgCost: 22.77
}

// 新算法（增加 lots 批次数组）
{
  code: 'A',
  name: 'A股票',
  quantity: 400,
  totalCost: 8496.0,
  avgCost: 21.24,
  lots: [
    { price: 21.24, quantity: 400, date: '2025-01-02' }
  ]
}
```

### 算法逻辑

#### 买入操作
```javascript
if (tx.type === 'buy') {
  // 添加新批次到队列末尾
  stock.lots.push({
    price: normalizedPrice,
    quantity: tx.quantity,
    date: tx.date,
  });
}
```

#### 卖出操作（FIFO）
```javascript
if (tx.type === 'sell') {
  let remainingToSell = tx.quantity;
  
  // 从队列头部开始扣除
  while (remainingToSell > 0 && stock.lots.length > 0) {
    const firstLot = stock.lots[0];
    
    if (firstLot.quantity <= remainingToSell) {
      // 这批全部卖出，移除
      remainingToSell -= firstLot.quantity;
      stock.lots.shift();
    } else {
      // 这批部分卖出，减少数量
      firstLot.quantity -= remainingToSell;
      remainingToSell = 0;
    }
  }
}
```

#### 最终计算
```javascript
// 汇总所有批次
let totalQuantity = 0;
let totalCost = 0;

for (const lot of stock.lots) {
  totalQuantity += lot.quantity;
  totalCost = add(totalCost, multiply(lot.price, lot.quantity));
}

// 计算加权平均成本（基于剩余批次）
avgCost = divide(totalCost, totalQuantity);
```

---

## 📊 实际案例对比

### 测试场景
```
1. 买入 400股 @ $24.58
2. 买入 470股 @ $21.24
3. 卖出 470股 @ $20.50
```

### 结果对比

| 项目 | 旧算法（加权平均）| 新算法（FIFO）| 说明 |
|------|------------------|---------------|------|
| **剩余数量** | 400股 | 400股 | 相同 |
| **剩余成本** | $22.77 | **$21.24** | FIFO 更真实 |
| **批次信息** | 无 | 批次2的剩余 | 可追溯 |
| **逻辑** | 平均混合 | 先进先出 | 更直观 |

### 如果继续在 $24.00 卖出

| 算法 | 单次盈亏 | 整体盈亏 | 是否匹配 |
|------|---------|---------|---------|
| 加权平均 | +$492 | -$579.80 | ❌ 假象 |
| FIFO | +$1,096 | -$579.80 | ⚠️ 仍需注意整体 |

**注意**：FIFO 解决了成本混合问题，但如果中间有亏损交易，整体仍可能亏钱。建议增加"已实现盈亏"显示。

---

## 🚀 后续改进建议

### 1. 显示已实现盈亏
在 UI 中分别显示：
- ✅ **已实现盈亏**：已完成交易的盈亏
- ✅ **未实现盈亏**：当前持仓按市价的盈亏
- ✅ **整体盈亏**：已实现 + 未实现

### 2. 批次明细查看
允许用户查看每只股票的批次详情：
```
A股票持仓明细：
- 批次1：200股 @ $20.50（2025-01-15）
- 批次2：300股 @ $22.30（2025-02-20）
```

### 3. 支持指定批次卖出（高级功能）
允许用户选择要卖出的批次（用于税务优化）

### 4. 算法选择（可选）
提供设置选项让用户选择：
- FIFO（先进先出）- 默认
- LIFO（后进先出）
- 指定批次

---

## ✅ 测试验证

### 测试文件
- `test_fifo_implementation.html` - FIFO 算法功能测试
- `analyze_cost_method.html` - 算法对比分析
- `profit_illusion_analysis.html` - 盈利假象分析

### 测试场景覆盖
- ✅ 基本买入/卖出
- ✅ 多批次管理
- ✅ FIFO 顺序验证
- ✅ 部分卖出
- ✅ 跨批次卖出
- ✅ 成本计算准确性
- ✅ 整体盈亏验证

---

## 📝 兼容性说明

### 数据格式
新算法返回的持仓对象增加了 `lots` 字段，但保持了原有字段的兼容性：
- `quantity` - 总数量
- `totalCost` - 总成本
- `avgCost` - 平均成本
- `lots` - **新增**：批次数组

### UI 兼容
现有 UI 无需修改，会自动使用新的 `avgCost` 值。如果需要显示批次详情，可以访问 `lots` 字段。

---

## 🎉 总结

通过将算法从**加权平均**升级为 **FIFO**：

1. ✅ 解决了成本混合不直观的问题
2. ✅ 真实反映剩余持仓的买入成本
3. ✅ 支持批次追溯和管理
4. ✅ 符合税务要求和券商惯例
5. ✅ 为未来高级功能（如指定批次卖出）打下基础

虽然 FIFO 不能完全解决"盈利假象"问题（需要增加已实现盈亏显示），但它提供了更透明、更符合直觉的成本计算方式。

