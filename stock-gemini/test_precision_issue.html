<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>收益率精度问题演示</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 16px; }
    .issue { color: #c62828; background: #ffebee; padding: 12px; border-radius: 4px; }
    .correct { color: #2e7d32; background: #e8f5e9; padding: 12px; border-radius: 4px; }
    code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>收益率精度问题演示</h1>
  <div id="results"></div>

  <script type="module">
    import { roundToDecimals, divide, multiply } from './js/precision.js';

    const results = document.getElementById('results');

    // 模拟一个实际的例子：很小的收益但相对收益率较高
    const profit = 0.123456;  // 0.123456美元的收益
    const cost = 10;          // 10美元的成本

    // 正确的计算方式：先计算完整精度的百分比，再进行显示精度处理
    const correctCalculation = (profit / cost) * 100;  // 1.23456%

    // 当前代码中可能的错误计算方式：先对原始值进行精度处理，再转换为百分比
    const roundedProfit = roundToDecimals(profit); // 0.12
    const roundedCost = roundToDecimals(cost);     // 10.00
    const incorrectCalculation = (roundedProfit / roundedCost) * 100; // 1.2%

    // 现有代码中的问题：对已经转换为百分比的值进行了精度处理
    const percentValue = (profit / cost) * 100; // 1.23456%
    const problematicRounding = roundToDecimals(percentValue); // 1.23%

    const resultDiv = document.createElement('div');
    resultDiv.innerHTML = `
      <h2>问题演示</h2>
      <div class="issue">
        <h3>现有代码中的精度问题</h3>
        <p>假设收益为 <code>0.123456</code> 美元，成本为 <code>10.00</code> 美元</p>
        <p>实际收益率 = <code>(0.123456 / 10.00) * 100% = 1.23456%</code></p>
        <p>现有代码处理后 = <code>roundToDecimals(1.23456) = 1.23%</code></p>
        <p><strong>丢失精度：</strong><code>1.23456% → 1.23%</code>，丢失了 <code>0.00456%</code> 的精度</p>
      </div>

      <div class="correct" style="margin-top: 16px;">
        <h3>正确的处理方式</h3>
        <p>应该保留计算过程中的完整精度，仅在显示时进行格式化处理</p>
        <p>收益率计算值 = <code>1.23456%</code>（保留完整精度）</p>
        <p>显示时格式化 = <code>1.23%</code>（保留2位小数用于显示）</p>
      </div>

      <h2>对小数值的影响</h2>
      <div class="issue">
        <h3>极端情况演示</h3>
        <p>假设收益为 <code>0.00123456789</code> 美元，成本为 <code>100.00</code> 美元</p>
        <p>实际收益率 = <code>(0.00123456789 / 100.00) * 100% = 0.00123456789%</code></p>
        <p>现有代码处理后 = <code>roundToDecimals(0.00123456789) = 0.00%</code></p>
        <p><strong>严重问题：</strong>收益率被错误地显示为 <code>0.00%</code>，而实际应为 <code>0.0012%</code></p>
      </div>

      <h2>建议修复方案</h2>
      <div class="correct">
        <h3>修改建议</h3>
        <p>在 <code>calculateProfitAnalysis</code> 函数中：</p>
        <pre>// 修改前
profitPercent: roundToDecimals(profitPercent),  // 错误：对百分比值进行了精度处理

// 修改后
profitPercent: profitPercent,  // 正确：保持完整精度，仅在显示时格式化

// 然后在UI显示时进行格式化
// 例如：profitPercent.toFixed(2) + '%'
        </pre>
        <p>这样可以确保计算精度不受损失，而仅在显示时进行适当的格式化。</p>
      </div>
    `;
    results.appendChild(resultDiv);
  </script>
</body>
</html>