<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>最终修复验证</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 16px; }
    .test-case { background: #f6f8fa; padding: 12px; border-radius: 4px; margin-bottom: 16px; }
    .pass { color: #2e7d32; background: #e8f5e9; padding: 12px; border-radius: 4px; margin-bottom: 16px; }
    .fail { color: #c62828; background: #ffebee; padding: 12px; border-radius: 4px; margin-bottom: 16px; }
    .value { font-weight: bold; }
  </style>
</head>
<body>
  <h1>最终修复验证</h1>
  <div id="results"></div>

  <script type="module">
    import { roundToDecimals, divide, multiply } from './js/precision.js';
    import { calculateHoldings, calculateProfitAnalysis } from './js/calculations.js';

    const results = document.getElementById('results');

    function testFinalFix() {
      // 测试您的案例：成本价302，现价541
      const holdings1 = {
        'TEST1': {
          code: 'TEST1',
          name: 'Test Stock 1',
          quantity: 1,
          totalCost: 302,
          avgCost: 302
        }
      };

      const userPrices1 = {
        'TEST1': 541
      };

      // 正确计算
      const correctProfitPercent1 = ((541 - 302) / 302) * 100; // 79.13907284768212
      const correctDisplay1 = correctProfitPercent1.toFixed(2); // 79.14

      // 系统计算
      const profitData1 = calculateProfitAnalysis(holdings1, userPrices1);
      const stock1 = profitData1.stockProfits[0];
      const systemDisplay1 = parseFloat(stock1.profitPercent.toFixed(2));

      // 测试案例2：成本价100，现价150
      const holdings2 = {
        'TEST2': {
          code: 'TEST2',
          name: 'Test Stock 2',
          quantity: 1,
          totalCost: 100,
          avgCost: 100
        }
      };

      const userPrices2 = {
        'TEST2': 150
      };

      // 正确计算
      const correctProfitPercent2 = ((150 - 100) / 100) * 100; // 50.00
      const correctDisplay2 = correctProfitPercent2.toFixed(2); // 50.00

      // 系统计算
      const profitData2 = calculateProfitAnalysis(holdings2, userPrices2);
      const stock2 = profitData2.stockProfits[0];
      const systemDisplay2 = parseFloat(stock2.profitPercent.toFixed(2));

      const resultDiv = document.createElement('div');

      resultDiv.innerHTML = `
        <h2>最终修复验证结果</h2>

        <div class="test-case">
          <h3>测试案例1：成本价302，现价541</h3>
          <p>正确收益率： <span class="value">${correctProfitPercent1}%</span></p>
          <p>正确显示结果： <span class="value">${correctDisplay1}%</span></p>
          <p>系统计算结果： <span class="value">${stock1.profitPercent}%</span></p>
          <p>系统显示结果： <span class="value">${systemDisplay1}%</span></p>
          <p>修复结果：
            <span class="${Math.abs(systemDisplay1 - parseFloat(correctDisplay1)) < 0.01 ? 'pass' : 'fail'}">
              ${Math.abs(systemDisplay1 - parseFloat(correctDisplay1)) < 0.01 ? '✅ 成功' : '❌ 失败'}
            </span>
          </p>
        </div>

        <div class="test-case">
          <h3>测试案例2：成本价100，现价150</h3>
          <p>正确收益率： <span class="value">${correctProfitPercent2}%</span></p>
          <p>正确显示结果： <span class="value">${correctDisplay2}%</span></p>
          <p>系统计算结果： <span class="value">${stock2.profitPercent}%</span></p>
          <p>系统显示结果： <span class="value">${systemDisplay2}%</span></p>
          <p>修复结果：
            <span class="${Math.abs(systemDisplay2 - parseFloat(correctDisplay2)) < 0.01 ? 'pass' : 'fail'}">
              ${Math.abs(systemDisplay2 - parseFloat(correctDisplay2)) < 0.01 ? '✅ 成功' : '❌ 失败'}
            </span>
          </p>
        </div>
      `;

      results.appendChild(resultDiv);
    }

    // 执行测试
    testFinalFix();
  </script>
</body>
</html>